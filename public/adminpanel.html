<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityPub Relay - Admin Panel</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ActivityPub Relay - Admin Panel</h1>
                <p class="subtitle">Manage your ActivityPub relay instance</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                🌙
            </button>
        </div>

        <div class="section api-key-input">
            <h2>API Key</h2>
            <div class="form-group">
                <label for="apiKey">API Key (必須)</label>
                <input type="password" id="apiKey" placeholder="Enter your API key">
            </div>
        </div>

        <div class="section">
            <h2>フォロー申請一覧</h2>
            <button onclick="loadFollowRequests()">申請を読み込む</button>
            <div id="followRequestsList" class="requests-list"></div>
            <div id="followRequestsResponse" class="response"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>設定取得</h2>
                <div class="form-group">
                    <label for="getSettingKey">設定キー</label>
                    <select id="getSettingKey">
                        <option value="auto_approve_follows">auto_approve_follows</option>
                    </select>
                </div>
                <button onclick="getSetting()">取得</button>
                <div id="getSettingResponse" class="response"></div>
            </div>

            <div class="section">
                <h2>設定更新</h2>
                <div class="form-group">
                    <label for="updateSettingKey">設定キー</label>
                    <select id="updateSettingKey">
                        <option value="auto_approve_follows">auto_approve_follows</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="updateSettingValue">値</label>
                    <select id="updateSettingValue">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </div>
                <button onclick="updateSetting()">更新</button>
                <div id="updateSettingResponse" class="response"></div>
            </div>
        </div>

        <div class="section">
            <h2>ドメインルール追加</h2>
            <div class="form-group">
                <label for="domainPattern">ドメインパターン</label>
                <input type="text" id="domainPattern" placeholder="example.com">
            </div>
            <div class="form-group">
                <label for="isRegex">正規表現</label>
                <select id="isRegex">
                    <option value="false">いいえ</option>
                    <option value="true">はい</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reason">理由 (オプション)</label>
                <input type="text" id="reason" placeholder="Spam domain">
            </div>
            <button onclick="addDomainRule()">追加</button>
            <div id="addDomainRuleResponse" class="response"></div>
        </div>

        <div class="section">
            <h2>ドメインルール一覧</h2>
            <button onclick="listDomainRules()">ルールを読み込む</button>
            <div id="domainRulesList" class="requests-list"></div>
            <div id="listDomainRulesResponse" class="response"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // テーマ管理
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');

            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeToggle.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        // 初期テーマ設定
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.getElementById('themeToggle');

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
            } else {
                document.body.classList.add('light-mode');
                themeToggle.textContent = '🌙';
            }
        }

        // ページ読み込み時にテーマを初期化
        initTheme();

        function getHeaders() {
            const apiKey = document.getElementById('apiKey').value;
            return {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey
            };
        }

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.style.display = 'block';
        }

        async function loadFollowRequests() {
            try {
                const params = new URLSearchParams({
                    limit: '50',
                    offset: '0'
                });
                const response = await fetch(`${API_BASE}/follow-requests?${params}`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (!response.ok) {
                    showResponse('followRequestsResponse', data, true);
                    return;
                }

                const listElement = document.getElementById('followRequestsList');
                if (data.requests && data.requests.length > 0) {
                    listElement.innerHTML = data.requests.map(req => `
                        <div class="request-item">
                            <div class="request-info">
                                <div class="request-id">ID: ${req.id}</div>
                                <div class="request-actor">Actor: ${req.actorId}</div>
                            </div>
                            <div class="request-actions">
                                <button onclick="approveRequest('${req.id}')">承認</button>
                                <button class="danger" onclick="rejectRequest('${req.id}')">拒否</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listElement.innerHTML = '<p>フォロー申請はありません</p>';
                }

                showResponse('followRequestsResponse', data);
            } catch (error) {
                showResponse('followRequestsResponse', { error: error.message }, true);
            }
        }

        async function approveRequest(id) {
            try {
                const response = await fetch(`${API_BASE}/follow-requests/${encodeURIComponent(id)}/approve`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    alert('承認しました');
                    loadFollowRequests();
                } else {
                    showResponse('followRequestsResponse', data, true);
                }
            } catch (error) {
                showResponse('followRequestsResponse', { error: error.message }, true);
            }
        }

        async function rejectRequest(id) {
            try {
                const response = await fetch(`${API_BASE}/follow-requests/${encodeURIComponent(id)}/reject`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    alert('拒否しました');
                    loadFollowRequests();
                } else {
                    showResponse('followRequestsResponse', data, true);
                }
            } catch (error) {
                showResponse('followRequestsResponse', { error: error.message }, true);
            }
        }

        async function getSetting() {
            const key = document.getElementById('getSettingKey').value;
            try {
                const response = await fetch(`${API_BASE}/settings/${key}`, {
                    headers: getHeaders()
                });
                const data = await response.json();
                showResponse('getSettingResponse', data, !response.ok);
            } catch (error) {
                showResponse('getSettingResponse', { error: error.message }, true);
            }
        }

        async function updateSetting() {
            const key = document.getElementById('updateSettingKey').value;
            const value = document.getElementById('updateSettingValue').value;
            try {
                const response = await fetch(`${API_BASE}/settings/${key}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ value })
                });
                const data = await response.json();
                showResponse('updateSettingResponse', data, !response.ok);
            } catch (error) {
                showResponse('updateSettingResponse', { error: error.message }, true);
            }
        }

        async function addDomainRule() {
            const pattern = document.getElementById('domainPattern').value;
            const isRegex = document.getElementById('isRegex').value === 'true';
            const reason = document.getElementById('reason').value;

            try {
                const response = await fetch(`${API_BASE}/domain-rules`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        pattern,
                        is_regex: isRegex,
                        reason: reason || undefined
                    })
                });
                const data = await response.json();
                showResponse('addDomainRuleResponse', data, !response.ok);

                if (response.ok) {
                    document.getElementById('domainPattern').value = '';
                    document.getElementById('reason').value = '';
                }
            } catch (error) {
                showResponse('addDomainRuleResponse', { error: error.message }, true);
            }
        }

        async function listDomainRules() {
            try {
                const params = new URLSearchParams({
                    limit: '50',
                    offset: '0'
                });
                const response = await fetch(`${API_BASE}/domain-rules?${params}`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (!response.ok) {
                    showResponse('listDomainRulesResponse', data, true);
                    return;
                }

                const listElement = document.getElementById('domainRulesList');
                if (data.rules && data.rules.length > 0) {
                    listElement.innerHTML = data.rules.map(rule => `
                        <div class="request-item">
                            <div class="request-info">
                                <div class="request-id">${rule.pattern} ${rule.is_regex ? '(正規表現)' : ''}</div>
                                <div class="request-actor">${rule.reason || 'No reason'}</div>
                            </div>
                            <div class="request-actions">
                                <button class="danger" onclick="deleteDomainRule(${rule.id})">削除</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listElement.innerHTML = '<p>ドメインルールはありません</p>';
                }

                showResponse('listDomainRulesResponse', data);
            } catch (error) {
                showResponse('listDomainRulesResponse', { error: error.message }, true);
            }
        }

        async function deleteDomainRule(id) {
            if (!confirm('このルールを削除しますか?')) return;

            try {
                const response = await fetch(`${API_BASE}/domain-rules/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    alert('削除しました');
                    listDomainRules();
                } else {
                    showResponse('listDomainRulesResponse', data, true);
                }
            } catch (error) {
                showResponse('listDomainRulesResponse', { error: error.message }, true);
            }
        }
    </script>
</body>
</html>
