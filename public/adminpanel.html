<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityPub Relay - Admin Panel</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ActivityPub Relay - Admin Panel</h1>
                <p class="subtitle">Manage your ActivityPub relay instance</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                ğŸŒ™
            </button>
        </div>

        <div class="section api-key-input">
            <h2>API Key</h2>
            <div class="form-group">
                <label for="apiKey">API Key (å¿…é ˆ)</label>
                <input type="password" id="apiKey" placeholder="Enter your API key">
            </div>
        </div>

        <div class="section">
            <h2>ãƒ•ã‚©ãƒ­ãƒ¼ç”³è«‹ä¸€è¦§</h2>
            <button onclick="loadFollowRequests()">ç”³è«‹ã‚’èª­ã¿è¾¼ã‚€</button>
            <div id="followRequestsList" class="requests-list"></div>
            <div id="followRequestsResponse" class="response"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>è¨­å®šå–å¾—</h2>
                <div class="form-group">
                    <label for="getSettingKey">è¨­å®šã‚­ãƒ¼</label>
                    <select id="getSettingKey">
                        <option value="auto_approve_follows">auto_approve_follows</option>
                    </select>
                </div>
                <button onclick="getSetting()">å–å¾—</button>
                <div id="getSettingResponse" class="response"></div>
            </div>

            <div class="section">
                <h2>è¨­å®šæ›´æ–°</h2>
                <div class="form-group">
                    <label for="updateSettingKey">è¨­å®šã‚­ãƒ¼</label>
                    <select id="updateSettingKey">
                        <option value="auto_approve_follows">auto_approve_follows</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="updateSettingValue">å€¤</label>
                    <select id="updateSettingValue">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </div>
                <button onclick="updateSetting()">æ›´æ–°</button>
                <div id="updateSettingResponse" class="response"></div>
            </div>
        </div>

        <div class="section">
            <h2>ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«è¿½åŠ </h2>
            <div class="form-group">
                <label for="domainPattern">ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                <input type="text" id="domainPattern" placeholder="example.com">
            </div>
            <div class="form-group">
                <label for="isRegex">æ­£è¦è¡¨ç¾</label>
                <select id="isRegex">
                    <option value="false">ã„ã„ãˆ</option>
                    <option value="true">ã¯ã„</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reason">ç†ç”± (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                <input type="text" id="reason" placeholder="Spam domain">
            </div>
            <button onclick="addDomainRule()">è¿½åŠ </button>
            <div id="addDomainRuleResponse" class="response"></div>
        </div>

        <div class="section">
            <h2>ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ä¸€è¦§</h2>
            <button onclick="listDomainRules()">ãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚€</button>
            <div id="domainRulesList" class="requests-list"></div>
            <div id="listDomainRulesResponse" class="response"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // ãƒ†ãƒ¼ãƒç®¡ç†
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');

            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeToggle.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        // åˆæœŸãƒ†ãƒ¼ãƒè¨­å®š
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.getElementById('themeToggle');

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.add('light-mode');
                themeToggle.textContent = 'ğŸŒ™';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ†ãƒ¼ãƒã‚’åˆæœŸåŒ–
        initTheme();

        function getHeaders() {
            const apiKey = document.getElementById('apiKey').value;
            return {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey
            };
        }

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.style.display = 'block';
        }

        async function loadFollowRequests() {
            try {
                const params = new URLSearchParams({
                    limit: '50',
                    offset: '0'
                });
                const response = await fetch(`${API_BASE}/follow-requests?${params}`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (!response.ok) {
                    showResponse('followRequestsResponse', data, true);
                    return;
                }

                const listElement = document.getElementById('followRequestsList');
                if (data.requests && data.requests.length > 0) {
                    listElement.innerHTML = data.requests.map(req => `
                        <div class="request-item">
                            <div class="request-info">
                                <div class="request-id">ID: ${req.id}</div>
                                <div class="request-actor">Actor: ${req.actorId}</div>
                            </div>
                            <div class="request-actions">
                                <button onclick="approveRequest('${req.id}')">æ‰¿èª</button>
                                <button class="danger" onclick="rejectRequest('${req.id}')">æ‹’å¦</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listElement.innerHTML = '<p>ãƒ•ã‚©ãƒ­ãƒ¼ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                }

                showResponse('followRequestsResponse', data);
            } catch (error) {
                showResponse('followRequestsResponse', { error: error.message }, true);
            }
        }

        async function approveRequest(id) {
            try {
                const response = await fetch(`${API_BASE}/follow-requests/${encodeURIComponent(id)}/approve`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    alert('æ‰¿èªã—ã¾ã—ãŸ');
                    loadFollowRequests();
                } else {
                    showResponse('followRequestsResponse', data, true);
                }
            } catch (error) {
                showResponse('followRequestsResponse', { error: error.message }, true);
            }
        }

        async function rejectRequest(id) {
            try {
                const response = await fetch(`${API_BASE}/follow-requests/${encodeURIComponent(id)}/reject`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    alert('æ‹’å¦ã—ã¾ã—ãŸ');
                    loadFollowRequests();
                } else {
                    showResponse('followRequestsResponse', data, true);
                }
            } catch (error) {
                showResponse('followRequestsResponse', { error: error.message }, true);
            }
        }

        async function getSetting() {
            const key = document.getElementById('getSettingKey').value;
            try {
                const response = await fetch(`${API_BASE}/settings/${key}`, {
                    headers: getHeaders()
                });
                const data = await response.json();
                showResponse('getSettingResponse', data, !response.ok);
            } catch (error) {
                showResponse('getSettingResponse', { error: error.message }, true);
            }
        }

        async function updateSetting() {
            const key = document.getElementById('updateSettingKey').value;
            const value = document.getElementById('updateSettingValue').value;
            try {
                const response = await fetch(`${API_BASE}/settings/${key}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ value })
                });
                const data = await response.json();
                showResponse('updateSettingResponse', data, !response.ok);
            } catch (error) {
                showResponse('updateSettingResponse', { error: error.message }, true);
            }
        }

        async function addDomainRule() {
            const pattern = document.getElementById('domainPattern').value;
            const isRegex = document.getElementById('isRegex').value === 'true';
            const reason = document.getElementById('reason').value;

            try {
                const response = await fetch(`${API_BASE}/domain-rules`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        pattern,
                        is_regex: isRegex,
                        reason: reason || undefined
                    })
                });
                const data = await response.json();
                showResponse('addDomainRuleResponse', data, !response.ok);

                if (response.ok) {
                    document.getElementById('domainPattern').value = '';
                    document.getElementById('reason').value = '';
                }
            } catch (error) {
                showResponse('addDomainRuleResponse', { error: error.message }, true);
            }
        }

        async function listDomainRules() {
            try {
                const params = new URLSearchParams({
                    limit: '50',
                    offset: '0'
                });
                const response = await fetch(`${API_BASE}/domain-rules?${params}`, {
                    headers: getHeaders()
                });
                const data = await response.json();

                if (!response.ok) {
                    showResponse('listDomainRulesResponse', data, true);
                    return;
                }

                const listElement = document.getElementById('domainRulesList');
                if (data.rules && data.rules.length > 0) {
                    listElement.innerHTML = data.rules.map(rule => `
                        <div class="request-item">
                            <div class="request-info">
                                <div class="request-id">${rule.pattern} ${rule.is_regex ? '(æ­£è¦è¡¨ç¾)' : ''}</div>
                                <div class="request-actor">${rule.reason || 'No reason'}</div>
                            </div>
                            <div class="request-actions">
                                <button class="danger" onclick="deleteDomainRule(${rule.id})">å‰Šé™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listElement.innerHTML = '<p>ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                }

                showResponse('listDomainRulesResponse', data);
            } catch (error) {
                showResponse('listDomainRulesResponse', { error: error.message }, true);
            }
        }

        async function deleteDomainRule(id) {
            if (!confirm('ã“ã®ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;

            try {
                const response = await fetch(`${API_BASE}/domain-rules/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                    listDomainRules();
                } else {
                    showResponse('listDomainRulesResponse', data, true);
                }
            } catch (error) {
                showResponse('listDomainRulesResponse', { error: error.message }, true);
            }
        }
    </script>
</body>
</html>
